====================================
Daily Operational HYSPLIT Model Runs
====================================

Daily HYSPLIT back trajectories are generated by the FORCE team for Cape Verde (CVAO), BT Tower (BTAO), and Weybourne (WAO) observatories, with a fourth run combining all three for comparative analysis. These runs provide crucial contextual information for observatory data interpretation.

-------------
Setup Summary
-------------

Daily, as part of our operational workflow, the following HYSPLIT back trajectory procedures are carried out:

**1. Configuration:**

* Simple setup control files are configured from a template file for each of the three observatories CVAO, BTAO, WAO and the combined run.
* The control files are configured for backward trajectory calculations for 240 hours (10 days).

**2. Parallel Execution:**

* Each observatory and the combined run is set up as its own instance, with a dedicated directory for its control and template files.
* These instances are then run in parallel across the cluster.

**3. Post-Processing:**

* `trajplot` is used to produce postscript (.ps) files from the model output.
* The postscript files are then converted to PNG (.png) files using `pstopng`.
* The images are renamed in the format `observatoryname_YYMMDDHH.png`.
* The images are transferred to the NCAS observations group workspace (GWS) in a dated directory.

**4. Data Archiving:**

* The model outputs data to small text files.
* These text files are also useful for analysis and are uploaded to the GWS.

---------------------------------------
Setup Details on the Thundercat Cluster
---------------------------------------

**1. User:**

* A specific user account (`force-hysplit-iceland`) is set up on the cluster to run the HYSPLIT model.

**2. Directory Structure:**

* This user account has multiple HYSPLIT configurations for various projects.
* The AMOF Observatory model runs are located in the `hysplit-nwr-runs` directory.
* Within this directory, there are folders for `cape_verde`, `weybourne`, `bttower`, and `observatories`.
* Each of these folders contains a specific template file for that location and the release heights for that case.

**3. Control Files:**

* The control files are configured for each observatory and the combined run.
* The basic structure of these files is very similar, with the main differences being the starting location and the release heights.
* This is an example control file for the Cape Verde Observatory for the 18:00 on the 25th of March 2025::

    25 03 12 18               #STARTING TIME: YEAR MONTH DAY HOUR
    3                         #NUMBER OF STARTING LOCATIONS
    16.854419 -24.863748 17         #STARTING 1: LATITUDE LONGITUDE HEIGHT (m-agl)
    16.854419 -24.863748 3000       #STARTING 1: LATITUDE LONGITUDE HEIGHT (m AGL)
    16.854419 -24.863748 6000       #STARTING 1: LATITUDE LONGITUDE HEIGHT (m AGL)
    -240                      #TOTAL RUN TIME (backwards)
    0                         #VERTICAL MOTION CALCULATION METHOD
    15500                     #TOP OF MODEL DOMAIN (m-AGL)
    8                         #NUMBER OF INPUT DATA GRIDS
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250312/
    hysplit.t00z.gfsf
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250312/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250311/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250310/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250309/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250308/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250307/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312/ftp.arl.noaa.gov/pub/forecast/20250306/
    hysplit.t00z.gfsa
    /home/force-hysplit-iceland/hysplit-nwr-runs/cape_verde/
    cape_verde_dump

Breakdown of the control file:

* The starting time is set to 25th March 2012 at 18:00.
* There are three starting locations, each with a different height.
* The total run time is set to 240 hours (10 days).
* The vertical motion calculation method is set to 0.
* The top of the model domain is set to 15500 m AGL.
* Defines how many GFS input files the run is expecting to cover the 10 days run time.
* The next 8 lines are the paths to the GFS input files.
* The last line is the path to the model dump file. (This is the file that is uploaded to the GWS)

**4. Template Files:**

* The template files are used to generate the control files for each run.
* These files contain the basic structure of the control file, with placeholders for the specific details of each run.

This is an example of a template file. ::

    YY MM DD HH               #STARTING TIME: YEAR MONTH DAY HOUR
3                         #NUMBER OF STARTING LOCATIONS
16.854419 -24.863748 17         #STARTING 1: LATITUDE LONGITUDE HEIGHT (m-agl)
16.854419 -24.863748 3000       #STARTING 1: LATITUDE LONGITUDE HEIGHT (m AGL)
16.854419 -24.863748 6000       #STARTING 1: LATITUDE LONGITUDE HEIGHT (m AGL)
-240                      #TOTAL RUN TIME (backwards)
0                         #VERTICAL MOTION CALCULATION METHOD
15500                     #TOP OF MODEL DOMAIN (m-AGL)
8                         #NUMBER OF INPUT DATA GRIDS
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/TODAY/
hysplit.t00z.gfsf
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/TODAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/ONE_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/TWO_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/THREE_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/FOUR_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/FIVE_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/TODAY/ftp.arl.noaa.gov/pub/forecast/SIX_DAY/
hysplit.t00z.gfsa
/home/force-hysplit-iceland/hysplit-nwr-runs/cape_verde/
cape_verde_dump

Breakdown of the template file:

* The starting time is set to the placeholders YY MM DD HH.
* There are three starting locations, each with a different height.
* The total run time is set to 240 hours (10 days).
* The vertical motion calculation method is set to 0.
* The top of the model domain is set to 15500 m AGL.
* Defines how many GFS input files the run is expecting to cover the 10 days run time.
* The next 8 lines are the paths to the GFS input files placeholders for the day of the file.
* The last line is the path to the model dump file.

There is a script that runs on a cron that will replaces the placeholder with the correct date and paths for the model run. 

**6. GFS data files:**

There is a cron that runs daily to download the required GFS data files for the model runs. The GFS data files are downloaded from the 
NOAA FTP server and stored in the `GFS-DATA` directory for example /home/force-hysplit-iceland/hysplit-nwr-runs/GFS-DATA/20250312

**6. Running the model:**

There is a cron script that calls a master script to run all the model instances in parallel. The master script will run the model for each observatory and the combined run. The model is run in parallel across the cluster.
This script also calls a script to download the required GFS data files. 


